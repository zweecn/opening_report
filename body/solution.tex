% !Mode:: "TeX:UTF-8"
\section{研究方案及进度安排}

\subsection{服务不确定性事件及服务状态模型}

\subsubsection{服务方案}

使用服务流程表示当前执行中的服务方案，表示为如式(\ref{equation:splan})所示。
\begin{equation}\label{equation:splan}
SPlan = \left( {A,E,fc,dc} \right)
\end{equation}
\begin{tabularx}{\textwidth}{@{}l@{\quad}l@{\pozhehao }X@{}}
    式中
    & ${A}$ & 活动集合，表示为~$\{{a_1}, {a_2},...,{a_n}\}$ ~； \\
    & ${E}$ & 活动之间的时序依赖关系，表示为~$\{{e_1}, {e_2},...,{e_n}\}$ ~；\\
    & ${fc}$ & 服务若执行失败，提供方需要支付给客户的补偿金；\\
    & ${dc}$ & 表示服务若执行延期，每单位时间延迟需要支付给客户的补偿金。
\end{tabularx}\vspace{\wordsep}

针对每个活动，可表示为如如式(\ref{equation:activity})所示。
\begin{equation}\label{equation:activity}
{a_i} = ({CS_i}, {S_{i0}}, {LST_i}, {LET_i})
\end{equation}
\begin{tabularx}{\textwidth}{@{}l@{\quad}l@{\pozhehao }X@{}}
    式中
    & ${CS_i}$ & 活动的可替换服务集；\\
    & ${S_{i0}}$ & 当前被选中用于执行该活动$i$的具体服务；\\
    & ${LST_i}$ & 最晚开始时间；\\
    & ${LET_i}$ & 最晚结束时间；
\end{tabularx}\vspace{\wordsep}

针对活动之间的依赖关系，一般的服务流程中存在各种复杂结构关系\citeup{jaeger2004qos}，本文考虑串行与并行两种关系，并使用如式(\ref{equation:e})表示，其意义是活动${a_j}$需要在活动${a_i}$执行完成后才能开始执行，在~DAG~图中体现的则是从结点${a_i}$到结点${a_j}$之间有一条有向边。
\begin{equation}\label{equation:e}
e = ({a_i},{a_j})
\end{equation}

对于候选服务，是以服务编号和~QoS~组成的二元组，如式(~\ref{equation:cs}~)所示。其QoS是以执行时间~$t$~、价格~$p$~，可靠性~$r$~组成的三元组，如式(~\ref{equation:qos}~)所示。

\begin{equation}\label{equation:cs}
CS = (id, QoS)
\end{equation}

\begin{equation}\label{equation:qos}
QoS = (t, p, r)
\end{equation}

\subsubsection{不确定性事件} \label{sec:uc_event}

本课题关注的是服务执行过程中从外界可观测到的事件，即站在服务使用者的角度观察系统的运行状态，而不关心服务执行环境内部是何种原因而产生的事件。这样做的原因是服务方案通常是由服务中介方负责构建的，方案中使用的各服务并不受其控制，故只能从外部观察。

事件可表示为如式(\ref{equation:event})所示，其中t为事件发生的时刻，a为事件所涉及的活动，EType表示事件的类型。
\begin{equation}\label{equation:event}
event = (t, a, EType)
\end{equation}
\begin{tabularx}{\textwidth}{@{}l@{\quad}l@{\pozhehao }X@{}}
    式中
    & $t$ & 事件发生的时刻；\\
    & $a$ & 事件所涉及的活动；\\
    & $Type$ &事件的类型。
\end{tabularx}\vspace{\wordsep}

考虑事件的类型~$EType$~。服务执行过程中的产生的事件分为两大类：正常事件、不确定性事件。前者是一项活动按计划正常开始和正常执行结束时所发出，后者是指活动未按预期开始或结束，或者执行失败。按照事件触发的机制，可分为以下三类：

\begin{itemize}
\item 由定时器所触发的事件，表示某活动未在期望时间点上开始执行或执行完成。服务执行引擎根据服务方案中为每个活动预设的最晚开始和最晚结束时刻对服务执行进行监控，如果到达~$LST_i$~或~$LET_i$~时刻活动未能开始或结束，将发出以下两类事件：

$E_{01}$:~活动~$a_i$~在当前时刻~$t$~未开始执行，满足~$t>LST_i+\delta$~ (~$\delta$~是一个足够小的时间间隔)，一旦系统在~$LST_i+\delta$~时刻未发现~$a_i$~开始执行，则发出该类事件；

$E_{02}$:~与之类似，活动~$a_i$~在当前时刻~$t$~未按计划执行结束，满足~$t>LETi+\delta$~；

\item 由活动的开始执行所触发的事件。一旦服务活动开始执行，系统即产生该类事件。

$E_{11}$:~活动准时/提前开始，此时~$t\le LST_i$~。

$E_{12}$:~活动延迟开始，此时~$t>LST_i$~。

\item 由活动执行结束所触发的事件，可分为以下两种情况：

$E_{21}$:~活动执行失败或错误，未得到期望结果；

$E_{22}$:~活动执行成功。~$t\le LET_i$~表示活动提前或准时执行结束，而~$t>LETi$~表示活动有延迟。

\end{itemize}


\subsubsection{服务执行的状态} \label{sec:service_state}

服务流程在执行过程中产生各种正常或不确定事件，导致服务执行不确定状态。本节给出服务执行状态的刻画。

(1)~单个服务的状态

首先定义活动的状态。对某活动~$a_i$~，其状态可表示为如式(\ref{equation:state})所示。

\begin{equation}\label{equation:state}
state(a_i)=STATE\_TYPE^{N/U}<T, C>
\end{equation}
\begin{tabularx}{\textwidth}{@{}l@{\quad}l@{\pozhehao }X@{}}
    式中
    & $T$ & 处于当前状态时相比于预期服务方案的时间延迟~(TimeDelay)~；\\
    & $C$ & 处于当前状态时相比于预期服务方案的成本溢出~(CostOverflow)~；\\
    & $N$ & 该状态为正常状态~(Normal)~，即时间和成本未超出初始服务方案中对~$a_i$~的时间与成本的规划~$(T\le 0, C\le 0)$~；\\
    & $U$ & 该状态为不正常状态~(Uncertain)~，即当前存在时间延迟或者成本溢出~$(T>0, C>0)$~；
\end{tabularx}\vspace{\wordsep}

式(\ref{equation:state})可简写为~$STATE\_TYPE^{N/U}$~。~$STATE\_TYPE$~可为以下6种类型之一，对~$NOT\_READY$~、~$FAIL$~、~$CANCEL$~三类状态来说，不存在正常或不正常的分类，可不需标注上标~$N$~或~$U$~。

\begin{itemize}

\item ~($NOT\_READY$):~$a_i$~至少有一个前序活动尚未执行结束，故~$a_i$~尚无开始执行的条件，即~$\exists a' \in \{ {a_j}|\exists e = ( {{a_j},{a_i}} )\} ,state ( {a'} ) \ne FINISH \Rightarrow state ( {{a_i}} ) = NOT\_READY$~。这是所有活动的缺省状态。

\item 待执行($READY$):~若~$a_i$~的所有前序活动均已执行完毕(处于~$FINISH$~状态)，且对这些活动的决策动作均非“终止”时，ai具备了执行的先决条件，进入该状态，即~$\forall a' \in \{ {a_j}|\exists e = ( {{a_j},{a_i}} )\} ,state ( {a'} ) = FINISH \wedge Action(a') \ne STOP \Rightarrow state ( {{a_i}} ) = READY$~。当~$a_i$~处于READY状态且产生~$E_{01}$~时，它仍然处于~$READY$~状态；

\item 执行中($EXEC$):~当本活动产生~$E_{11}$~、~$E_{02}$~事件时，~$a_i$~正在执行中，但尚未结束；

\item 执行后失败($FAIL$):~本活动产生~$E_{21}$~事件，~$a_i$~执行结束，但未得到期望输出，执行失败；

\item 执行后成功~($FINISH$):~本活动产生~$E_{22}$~事件，~$a_i$~执行结束，已得到期望结果；

\item 取消~($CANCEL$):~当某活动处于~$READYU$~、~$FINISHU$~或~$FAIL$~状态，并且决策动作将该活动终止时，~$a_i$~被人为取消，服务方案停止执行而完全失败。
\end{itemize}

事件或决策动作导致活动的状态变化，状态之间的转换关系如图~\ref{figure:state_trans}~所示。
\begin{figure}[htbp]
    \centering
    \includegraphics[width = 0.6\textwidth]{state_trans}
    \caption{服务活动的状态转换关系}\label{figure:state_trans}
    \vspace{-1em}
\end{figure}

(2)~服务执行的整体状态

将服务执行“前锋线”~(forward line)~上的各服务活动的状态联合起来，共同表示服务执行的整体状态~state(SPlan)~，如式(\ref{equation:state_total})所示。

\begin{equation}\label{equation:state_total}
state = < state(a_i),state(a_{i+1}),..., state(a_j)>
\end{equation}
\begin{tabularx}{\textwidth}{@{}l@{\quad}l@{\pozhehao }X@{}}
    式中
    & $state(a_i)$ & 活动~$a_i$~的状态。
\end{tabularx}\vspace{\wordsep}

所谓的“前锋线”~(Front Line)~，是指将已经执行的部分和尚未执行的部分分开的一条线，表示为~$FL(SPlan)=\{(a_i, state(a_i))\}$~，它由一组活动及其状态构成，~$prodecessor(FL)$~、~$successor(FL)$~分别为其左侧和右侧的活动集合。处于~$FL$~中的每一个服务，可能是~$READY^{N/U}$~、~$EXEC^{N/U}$~、~$FAIL$~、~$FINISH^{N/U}$~的某一状态，其所有前序活动的状态必须是~$FINISH^{N/U}$~，其所有后序活动的状态必须是~$NOT\_READY$~，即
$\forall {a_i} \in FL,state({a_i}) \in \{ READ{Y^{N/U}},{\rm{ }}EXE{C^{N/U}},{\rm{ }}FAIL,{\rm{ }}FINIS{H^{N/U}}\} ;\forall a' \in predecessor(FL),state(a') = FINIS{H^{N/U}};\forall a' \in successor(FL),state(a') = NOT\_READY.$

例如，在某一时刻服务执行状态如图~\ref{figure:front_line}~所示，虚线表示流程执行的前锋线，它左侧的活动~$(a_1, a_2, a_5)$~均处于~$FINISH$~状态，它右侧的活动~$(a_7, a_8, a_9)$~均处于~$NOT\_READY$~状态，而在线上的三个活动~$(a_3, a_4, a_6)$~，分别处于~$READY$~、~$EXEC$~、~$FAIL$~状态。

\begin{figure}[htbp]
    \centering
    \includegraphics[width = 0.5\textwidth]{front_line}
    \caption{服务方案执行中的状态划分与前锋线}\label{figure:front_line}
    \vspace{-1em}
\end{figure}

~$state(SPlan)$~可分为几类：
\begin{itemize}
\item 执行前: ~$predecessor(FL) = \emptyset ,$ 对 $ \forall {a_i} \in FL,state({a_i}) = READ{Y^N}$~；
\item 执行中: ~$FL \ne \emptyset ,predecessor(FL) \ne \emptyset ,successor(FL) \ne \emptyset $~；
\item 执行结束(成功): ~$FL = \emptyset ,successor(FL) = \emptyset ,$ 对 $\forall {a_i} \in predecessor(FL),state({a_i}) = FINIS{H^{N/U}}$~；
\item 执行结束(失败): ~$FL \ne \emptyset ,$ 且 $\exists {a_i} \in FL,state({a_i}) = FAIL$~；
\end{itemize}

面向不确定性的优化决策的目标可表述为：以最小的时间延迟和成本溢出，使服务可最大概率的进入到“成功结束”状态。

\subsection{软件层面面向不确定性的服务自适应决策模型}

\subsubsection{决策动作} \label{sec:action}

针对每一种不确定性，有多种可用的决策动作，需要识别出可能的决策动作，对其分类，并估算“若采取某项决策动作，可能会付出的直接/间接成本，以及对服务预期收益的影响”。将每一次决策表示为四元组~$SPlan,{a_i},state,action,SPlan'$~，含义是：当前服务执行方案~$SPlan$~，出现了不确定性事件导致某服务活动~$a_j$~进入状态~$state_j$~，此时采取对策~$action$~，得到新的方案~$SPlan'$~。

课题拟将决策动作归纳为五类：
\begin{enumerate}
\item 终止~(terminate):~停止活动的执行，~$state(a_i)=FAIL$~，客户需求无法满足，服务失败，~$SPlan'=\emptyset $~；
\item 不作为~(continue):~不做额外的调整对策，继续按原方案执行下去，~$SPlan'=SPlan$~；
\item 重试~(retry):~重新执行出现异常的活动，即令~$state(a_i)=EXECU(T, C)$~；
\item 替换~(substitute):~为出现异常的活动~$a_i$~从其候选服务集~$CS_i$~中选择一个新服务~$S_{ij}$~替换原服务~$S_{i0}$~，并重新启动执行~$a_i$~，即：~${S_i}_0 \leftarrow {S_{ik}}$~，其中~${S_{ik}} \in C{S_i}$~；
\item 重组~(recompose):~对当前前锋线的右侧尚未执行的服务活动进行重组，形成替代方案并启动执行。这相当于对多个服务要素进行替换操作。即：将多个服务~${S_i}_0,{S_{i + 1,0}}, \ldots ,{S_j}_0$~分别替换为~${S_i}_k,{S_{i + 1,k}}, \ldots ,{S_j}_k$~, 其中~${S_i}_k \in C{S_i},{S_{i + 1,k}} \in C{S_{i + 1}}, \ldots ,{S_j}_k \in C{S_j}$~。
\end{enumerate}

终止、不作为和重试对服务方案的结构无影响，替换相当于为某一活动进行服务选择，重组相当于对后续未执行服务流程进行服务重组。替换和重组是为尚未执行的一个或多个活动选择时间更短或价格更低的候选服务，以此来消除之前因为不确定事件所导致的时间延误或成本溢出，替换可相当于对1个活动进行重新选择和组合服务，而在工作流不变的情况下的重组相当于对多个活动进行替换和组合服务。在此之前，需要根据~$SPlan$~的当前状态动态生成替换和重组的目标函数，使得当前造成的时间延误和成本溢出将最大程度的降低。

\subsubsection{事件、决策和状态之间的关系}

在服务方案执行过程中，某时刻若产生某一不确定性事件，则会导致某一活动状态发生变化(若是正常事件，也可能不发生变化)。此时进行决策，根据决策动作修正服务方案并更新受影响的活动状态，继续投入执行。如此循环往复，直到服务停止或者执行成功。对活动执行前、执行后的状态，一旦该状态产生，马上进行决策；对活动执行中的状态，等活动达到执行后的某一状态时再进行决策。

需要说明的是，虽然决策针对服务的整体状态，但是每次动作只针对前锋线上的某一个活动进行。若前锋线上多个活动均处于异常状态，那么多个导致异常状态的事件必然是有先后次序到达的，因而决策也会随事件到达的先后次序进行。因此，决策只需要针对单一活动的状态进行，不需要针对多个异常活动进行。

针对服务所处的不同状态，可能采取的决策动作是上述五类中的子集。表~\ref{table:state_action}~的前四列给出了某一活动处于不同状态时可能采用的决策动作集合，以及决策之后可能导致的新状态。


% Table generated by Excel2LaTeX from sheet 'Sheet9'
\begin{table}[htbp]
    \caption{服务状态与决策动作之间的关系(软件层面)}
    \vspace{-0.5em}\label{table:state_action}\centering\zihao{5}
    \begin{threeparttable}
        \begin{tabular}{llllllll}
            %    \begin{tabularx}{\textwidth}{llXlllll}
            \toprule
            % Header
            \multicolumn{1}{|c|}{} 
            & \multicolumn{1}{c}{状态类型} 
            & \multicolumn{1}{|c}{{决策动作}} 
            & \multicolumn{1}{|c}{决策后可能导致的状态} 
            & \multicolumn{1}{|c}{$r^{[2]}$} 
            & \multicolumn{1}{|c}{$\Delta T$} 
            & \multicolumn{1}{|c|}{$\Delta C$} \\
            \hline
            
            %Line 1
            \multicolumn{1}{|c|}{\multirow{9}{*}{\parbox{1em}{活动执行前的状态}}} 
            & \multirow{7}{*}{$READY^U(T,C$)} 
            & \multicolumn{1}{|c}{{终止}} 
            & \multicolumn{1}{|l}{$STOP(T, C+\Delta C$)} 
            & \multicolumn{1}{|c}{0} 
            & \multicolumn{1}{|c}{0} 
            & \multicolumn{1}{|c|}{$fc$} \\
            \cline{3-7}
            
            %Line 2
            \multicolumn{1}{|c|}{} 
            &       
            & \multicolumn{1}{|c}{\multirow{2}{*}{{不作为}}} 
            & \multicolumn{1}{|l}{$FINISH^{N/U}(T+\Delta T, C+\Delta C$)} 
            & \multicolumn{1}{|c}{$R_{i0}$} 
            & \multicolumn{1}{|c}{\multirow{2}{*}{0}} 
            & \multicolumn{1}{|c|}{\multirow{2}{*}{0}} \\
            %        \cline{4-5}
            
            %Line 3
            \multicolumn{1}{|c|}{} 
            &       
            & \multicolumn{1}{|c}{} 
            & \multicolumn{1}{|l}{$FAIL(T+\Delta T, C+\Delta C)$} 
            & \multicolumn{1}{|c}{0}
            & \multicolumn{1}{|c}{} 
            & \multicolumn{1}{|c|}{} \\
            \cline{3-7}
            
            %Line 4
            \multicolumn{1}{|c|}{} 
            &       
            & \multicolumn{1}{|c}{\multirow{2}{*}{替换}} 
            & \multicolumn{1}{|l}{$FINISH^{N/U}(T+\Delta T, C+\Delta C$} 
            & \multicolumn{1}{|c}{$R_{ik}^{[3]}$} 
            & \multicolumn{1}{|c}{\multirow{2}{*}{$T_{ik}-T_{i0}$}} 
            & \multicolumn{1}{|c|}{\multirow{2}{*}{$C_{ik}-C_{i0}$}} \\
            %        \cline{4-5}
            
            %Line 5
            \multicolumn{1}{|c|}{} 
            &       
            & \multicolumn{1}{|c}{} 
            & \multicolumn{1}{|l}{$FAIL(T+\Delta T,C+\Delta C)$} 
            & \multicolumn{1}{|c}{0} 
            & \multicolumn{1}{|c}{} 
            & \multicolumn{1}{|c|}{} \\
            \cline{3-7}
            
            %Line 6
            \multicolumn{1}{|c|}{} 
            &       
            & \multicolumn{1}{|c}{\multirow{2}{*}{重组}} 
            & \multicolumn{1}{|l}{$FINISH^{N/U}(T+\Delta T,C+\Delta C)$} 
            & \multicolumn{1}{|c}{$R_{ik}^{[3]}$} 
            %        & \multirow{2}{*}{$\sum\limits_{x = i}^j {({T_{xk}} - {T_{x0}})} $} 
            & \multicolumn{1}{|c}{\multirow{2}{*}{$\sum\limits_{x = i}^j {({T_{xk}} - {T_{x0}})} $}}
            & \multicolumn{1}{|c|}{\multirow{2}{*}{$\sum\limits_{x = i}^j {({C_{xk}} - {C_{x0}})} $}} \\
            
            %Line 7
            \multicolumn{1}{|c|}{} 
            &       
            & \multicolumn{1}{|c}{} 
            & \multicolumn{1}{|l}{$FAIL(T+\Delta T,C+\Delta C)$} 
            & \multicolumn{1}{|c}{0} 
            & \multicolumn{1}{|c}{}
            & \multicolumn{1}{|c|}{} \\
            \cline{2-7}
            
            %Line 8
            \multicolumn{1}{|c|}{} 
            & \multirow{2}{*}{$READY^N(T,C)$} 
            & \multicolumn{1}{|c}{\multirow{2}{*}{无需决策}} 
            & \multicolumn{1}{|l}{$FINISH^{N/U}(T+\Delta T,C+\Delta C)$} 
            & \multicolumn{1}{|c}{$R_{i0}$} 
            & \multicolumn{1}{|c}{\multirow{2}{*}{0}} 
            & \multicolumn{1}{|c|}{\multirow{2}{*}{0}} \\
            
            %Line 9
            \multicolumn{1}{|c|}{} 
            &       
            & \multicolumn{1}{|c}{} 
            & \multicolumn{1}{|l}{$FAIL(T+\Delta T,C+\Delta C)$} 
            & \multicolumn{1}{|c}{0} 
            & \multicolumn{1}{|c}{} 
            & \multicolumn{1}{|c|}{} \\
            \cline{1-7}
            
            %Line 10
            \multicolumn{1}{|c|}{\multirow{11}{*}{\parbox{1em}{活动执行后的状态}}} 
            & \multirow{7}{*}{$FAIL(T,C)$} 
            & \multicolumn{1}{|c}{终止} 
            & \multicolumn{1}{|l}{$STOP(T,C+\Delta C)$} 
            & \multicolumn{1}{|c}{0} 
            & \multicolumn{1}{|c}{0} 
            & \multicolumn{1}{|c|}{$fc$} \\
            \cline{3-7}
            
            %Line 11
            \multicolumn{1}{|c|}{} 
            &       
            & \multicolumn{1}{|c}{\multirow{2}{*}{重试}} 
            & \multicolumn{1}{|l}{$FINISH^{N/U}(T+\Delta T,C+\Delta C)$} 
            & \multicolumn{1}{|c}{$R_{i0}$} 
            & \multicolumn{1}{|c}{\multirow{2}{*}{$T_{i0}$}} 
            & \multicolumn{1}{|c|}{\multirow{2}{*}{$C_{i0}$}} \\
            
            %Line 12
            \multicolumn{1}{|c|}{} 
            &       
            & \multicolumn{1}{|c}{}
            & \multicolumn{1}{|l}{$FAIL(T+\Delta T,C+\Delta C)$} 
            & \multicolumn{1}{|c}{0} 
            & \multicolumn{1}{|c}{}
            & \multicolumn{1}{|c|}{} \\
            \cline{3-7}
            
            %Line 13
            \multicolumn{1}{|c|}{} 
            &       
            & \multicolumn{1}{|c}{\multirow{2}{*}{替换}} 
            & \multicolumn{1}{|l}{$FINISH^{N/U}(T+\Delta T,C+\Delta C)$} 
            & \multicolumn{1}{|c}{$R_{ik}^{[3]}$} 
            & \multicolumn{1}{|c}{\multirow{2}{*}{${T_{ik}}$}} 
            & \multicolumn{1}{|c|}{\multirow{2}{*}{${C_{ik}}$}} \\
            
            %Line 14 
            \multicolumn{1}{|c|}{} 
            &       
            & \multicolumn{1}{|c}{} 
            & \multicolumn{1}{|l}{$FAIL(T+\Delta T,C+\Delta C)$} 
            & \multicolumn{1}{|c}{0} 
            & \multicolumn{1}{|c}{} 
            & \multicolumn{1}{|c|}{} \\
            \cline{3-7}
            
            %Line 15
            \multicolumn{1}{|c|}{} 
            &       
            & \multicolumn{1}{|c}{\multirow{2}{*}{重组}} 
            & \multicolumn{1}{|l}{$FINISH^{N/U}(T+\Delta T,C+\Delta C)$} 
            & \multicolumn{1}{|c}{$R_{ik}^{[3]}$} 
            & \multicolumn{1}{|c}{\multirow{2}{*}{${T_{i0}} + \sum\limits_{x = i}^j {({T_{xk}} - {T_{x0}})} $}}
            & \multicolumn{1}{|c|}{\multirow{2}{*}{${C_{i0}} + \sum\limits_{x = i}^j {({C_{xk}} - {C_{x0}})} $}} \\
            %        & \multicolumn{1}{|c}{\multirow{2}{*}{$\begin{array}{l}
            %                \sum\limits_{x = i}^j {({T_{xk}} - {T_{x0}})} \\
            %                {\kern 10pt}  + {T_{i0}}
            %                \end{array}$}} 
            %        & \multicolumn{1}{|c}{\multirow{2}{*}{$\begin{array}{l}
            %                \sum\limits_{x = i}^j {({C_{xk}} - {C_{x0}})} \\
            %                {\kern 10pt}  + {C_{i0}}
            %                \end{array}$}}  \\
            
            %Line 16
            \multicolumn{1}{|c|}{} 
            &       
            & \multicolumn{1}{|c}{} 
            & \multicolumn{1}{|l}{$FAIL(T+\Delta T,C+\Delta C)$} 
            & \multicolumn{1}{|c}{0} 
            & \multicolumn{1}{|c}{} 
            & \multicolumn{1}{|c|}{} \\
            \cline{2-7}
            
            %Line 17
            \multicolumn{1}{|c|}{} 
            & \multirow{3}{*}{$FINISH^U(T,C)$} 
            & \multicolumn{1}{|c}{不作为} 
            & \multicolumn{1}{|l}{后续活动$READY^U(T,C)^{[1]}$} 
            & \multicolumn{1}{|c}{1} 
            & \multicolumn{1}{|c}{0} 
            & \multicolumn{1}{|c|}{0} \\
            \cline{3-7}
            
            %Line 18
            \multicolumn{1}{|c|}{} 
            &       
            & \multicolumn{1}{|c}{终止} 
            & \multicolumn{1}{|l}{$STOP(T,C+\Delta C)$} 
            & \multicolumn{1}{|c}{0} 
            & \multicolumn{1}{|c}{0} 
            & \multicolumn{1}{|c|}{$fc$} \\
            \cline{3-7}
            
            %Line 19
            \multicolumn{1}{|c|}{} 
            &       
            & \multicolumn{1}{|c}{重组} 
            & \multicolumn{1}{|l}{后续活动$READY^{N/U}(T,C)^[1]$} 
            & \multicolumn{1}{|c}{1} 
            & \multicolumn{1}{|c}{$\sum\limits_{x = i}^j {({T_{xk}} - {T_{x0}})} $} 
            & \multicolumn{1}{|c|}{$\sum\limits_{x = i}^j {({C_{xk}} - {C_{x0}})} $}  \\
            \cline{2-7}
            
            %Line 20
            \multicolumn{1}{|c|}{} 
            & $FINISH^N(T,C)$
            & \multicolumn{1}{|c}{无需决策} 
            & \multicolumn{1}{|l}{后续活动$READY^N(T,C)^[1]$} 
            & \multicolumn{1}{|c}{1} 
            & \multicolumn{1}{|c}{0} 
            & \multicolumn{1}{|c|}{0} \\
            \bottomrule
            
            \multicolumn{7}{l}{[1] \textit{是否可以过渡到后续活动的READY状态，取决于流程的结构，只有后续活动的所有前序活动均处于}}  \\
            \multicolumn{7}{l}{\textit{~~~~FINISH且不采用“终止”决策时才能够过渡到READY;}} \\
            \multicolumn{7}{l}{[2] \textit{$r$为决策后,服务可继续执行的概率; }}  \\
            \multicolumn{7}{l}{[3] \textit{$S_{ik}$为替换后的服务或者重组后最先执行的服务。 }}  \\
        \end{tabular}%
    \begin{tablenotes}
        \item[1] 决策动作前状态所带参数为$(T,C)$, 决策后状态参数变为~$(T+\Delta T, C+\Delta C)$,~ 其中~$\Delta T \ge 0$, ~$\Delta C \ge 0$~; 
        \item[2] $r$~为决策后,服务可继续执行的概率;
        \item[3] $S_{ik}$~为替换后的服务或者重组后最先执行的服务，~$R_{ik}$~为此服务的可靠性。
        %        是否可以过渡到后续活动的~$READY$~状态，取决于流程的结构，只有后续活动的所有前序活动均处于~$FINISH$~且不采用“终止”决策时才能够过渡到READY;
    \end{tablenotes}
\end{threeparttable}
\end{table}%

%\begin{table}[htbp]
%    \caption{服务状态与决策动作之间的关系}
%    \vspace{-0.5em}\label{table:state_action}\centering\zihao{5}
%    %    \includegraphics[width = 0.9\textwidth, bb=0 0 800 600]{state_action}
%    \includegraphics[width = 0.95\textwidth]{state_action}
%\end{table}

%% Table generated by Excel2LaTeX from sheet 'Sheet9'
%\begin{table}[htbp]
%      \caption{服务状态与决策动作之间的关系(软件层面)}
%\newsavebox{\tablebox} %add
%\begin{lrbox}{\tablebox} %add
%      \vspace{-0.5em}\label{table:state_action}\centering\zihao{5}
%    \begin{tabular}{llllllll}
%%    \begin{tabularx}{\textwidth}{llXlllll}
%        \toprule
%% Header
%        \multicolumn{1}{|c|}{} 
%        & \multicolumn{1}{c}{状态类型} 
%        & \multicolumn{1}{|c}{{决策动作}} 
%        & \multicolumn{1}{|c}{决策后可能导致的状态} 
%        & \multicolumn{1}{|c}{$r^{[2]}$} 
%        & \multicolumn{1}{|c}{$\Delta T$} 
%        & \multicolumn{1}{|c|}{$\Delta C$} \\
%        \hline
%
%%Line 1
%        \multicolumn{1}{|c|}{\multirow{9}{*}{\parbox{1em}{活动执行前的状态}}} 
%        & \multirow{7}{*}{$READY^U(T,C$)} 
%        & \multicolumn{1}{|c}{{终止}} 
%        & \multicolumn{1}{|l}{$STOP(T, C+\Delta C$)} 
%        & \multicolumn{1}{|c}{0} 
%        & \multicolumn{1}{|c}{0} 
%        & \multicolumn{1}{|c|}{$fc$} \\
%        \cline{3-7}
%
%%Line 2
%        \multicolumn{1}{|c|}{} 
%        &       
%        & \multicolumn{1}{|c}{\multirow{2}{*}{{不作为}}} 
%        & \multicolumn{1}{|l}{$FINISH^{N/U}(T+\Delta T, C+\Delta C$)} 
%        & \multicolumn{1}{|c}{$R_{i0}$} 
%        & \multicolumn{1}{|c}{\multirow{2}{*}{0}} 
%        & \multicolumn{1}{|c|}{\multirow{2}{*}{0}} \\
%%        \cline{4-5}
%
%%Line 3
%        \multicolumn{1}{|c|}{} 
%        &       
%        & \multicolumn{1}{|c}{} 
%        & \multicolumn{1}{|l}{$FAIL(T+\Delta T, C+\Delta C)$} 
%        & \multicolumn{1}{|c}{0}
%        & \multicolumn{1}{|c}{} 
%        & \multicolumn{1}{|c|}{} \\
%        \cline{3-7}
%
%%Line 4
%        \multicolumn{1}{|c|}{} 
%        &       
%        & \multicolumn{1}{|c}{\multirow{2}{*}{替换}} 
%        & \multicolumn{1}{|l}{$FINISH^{N/U}(T+\Delta T, C+\Delta C$} 
%        & \multicolumn{1}{|c}{$R_{ik}^{[3]}$} 
%        & \multicolumn{1}{|c}{\multirow{2}{*}{$T_{ik}-T_{i0}$}} 
%        & \multicolumn{1}{|c|}{\multirow{2}{*}{$C_{ik}-C_{i0}$}} \\
%%        \cline{4-5}
%
%%Line 5
%        \multicolumn{1}{|c|}{} 
%        &       
%        & \multicolumn{1}{|c}{} 
%        & \multicolumn{1}{|l}{$FAIL(T+\Delta T,C+\Delta C)$} 
%        & \multicolumn{1}{|c}{0} 
%        & \multicolumn{1}{|c}{} 
%        & \multicolumn{1}{|c|}{} \\
%        \cline{3-7}
%
%%Line 6
%        \multicolumn{1}{|c|}{} 
%        &       
%        & \multicolumn{1}{|c}{\multirow{2}{*}{重组}} 
%        & \multicolumn{1}{|l}{$FINISH^{N/U}(T+\Delta T,C+\Delta C)$} 
%        & \multicolumn{1}{|c}{$R_{ik}^{[3]}$} 
%%        & \multirow{2}{*}{$\sum\limits_{x = i}^j {({T_{xk}} - {T_{x0}})} $} 
%        & \multicolumn{1}{|c}{\multirow{2}{*}{$\sum\limits_{x = i}^j {({T_{xk}} - {T_{x0}})} $}}
%        & \multicolumn{1}{|c|}{\multirow{2}{*}{$\sum\limits_{x = i}^j {({C_{xk}} - {C_{x0}})} $}} \\
%
%%Line 7
%        \multicolumn{1}{|c|}{} 
%        &       
%        & \multicolumn{1}{|c}{} 
%        & \multicolumn{1}{|l}{$FAIL(T+\Delta T,C+\Delta C)$} 
%        & \multicolumn{1}{|c}{0} 
%        & \multicolumn{1}{|c}{}
%        & \multicolumn{1}{|c|}{} \\
%        \cline{2-7}
%
%%Line 8
%        \multicolumn{1}{|c|}{} 
%        & \multirow{2}{*}{$READY^N(T,C)$} 
%        & \multicolumn{1}{|c}{\multirow{2}{*}{无需决策}} 
%        & \multicolumn{1}{|l}{$FINISH^{N/U}(T+\Delta T,C+\Delta C)$} 
%        & \multicolumn{1}{|c}{$R_{i0}$} 
%        & \multicolumn{1}{|c}{\multirow{2}{*}{0}} 
%        & \multicolumn{1}{|c|}{\multirow{2}{*}{0}} \\
%
%%Line 9
%        \multicolumn{1}{|c|}{} 
%        &       
%        & \multicolumn{1}{|c}{} 
%        & \multicolumn{1}{|l}{$FAIL(T+\Delta T,C+\Delta C)$} 
%        & \multicolumn{1}{|c}{0} 
%        & \multicolumn{1}{|c}{} 
%        & \multicolumn{1}{|c|}{} \\
%        \cline{1-7}
%
%%Line 10
%        \multicolumn{1}{|c|}{\multirow{11}{*}{\parbox{1em}{活动执行后的状态}}} 
%        & \multirow{7}{*}{$FAIL(T,C)$} 
%        & \multicolumn{1}{|c}{终止} 
%        & \multicolumn{1}{|l}{$STOP(T,C+\Delta C)$} 
%        & \multicolumn{1}{|c}{0} 
%        & \multicolumn{1}{|c}{0} 
%        & \multicolumn{1}{|c|}{$fc$} \\
%        \cline{3-7}
%
%%Line 11
%        \multicolumn{1}{|c|}{} 
%        &       
%        & \multicolumn{1}{|c}{\multirow{2}{*}{重试}} 
%        & \multicolumn{1}{|l}{$FINISH^{N/U}(T+\Delta T,C+\Delta C)$} 
%        & \multicolumn{1}{|c}{$R_{i0}$} 
%        & \multicolumn{1}{|c}{\multirow{2}{*}{$T_{i0}$}} 
%        & \multicolumn{1}{|c|}{\multirow{2}{*}{$C_{i0}$}} \\
%
%%Line 12
%        \multicolumn{1}{|c|}{} 
%        &       
%        & \multicolumn{1}{|c}{}
%        & \multicolumn{1}{|l}{$FAIL(T+\Delta T,C+\Delta C)$} 
%        & \multicolumn{1}{|c}{0} 
%        & \multicolumn{1}{|c}{}
%        & \multicolumn{1}{|c|}{} \\
%        \cline{3-7}
%
%%Line 13
%        \multicolumn{1}{|c|}{} 
%        &       
%        & \multicolumn{1}{|c}{\multirow{2}{*}{替换}} 
%        & \multicolumn{1}{|l}{$FINISH^{N/U}(T+\Delta T,C+\Delta C)$} 
%        & \multicolumn{1}{|c}{$R_{ik}^{[3]}$} 
%        & \multicolumn{1}{|c}{\multirow{2}{*}{${T_{ik}}$}} 
%        & \multicolumn{1}{|c|}{\multirow{2}{*}{${C_{ik}}$}} \\
%
%%Line 14 
%        \multicolumn{1}{|c|}{} 
%        &       
%        & \multicolumn{1}{|c}{} 
%        & \multicolumn{1}{|l}{$FAIL(T+\Delta T,C+\Delta C)$} 
%        & \multicolumn{1}{|c}{0} 
%        & \multicolumn{1}{|c}{} 
%        & \multicolumn{1}{|c|}{} \\
%        \cline{3-7}
%
%%Line 15
%        \multicolumn{1}{|c|}{} 
%        &       
%        & \multicolumn{1}{|c}{\multirow{2}{*}{重组}} 
%        & \multicolumn{1}{|l}{$FINISH^{N/U}(T+\Delta T,C+\Delta C)$} 
%        & \multicolumn{1}{|c}{$R_{ik}^{[3]}$} 
%        & \multicolumn{1}{|c}{\multirow{2}{*}{${T_{i0}} + \sum\limits_{x = i}^j {({T_{xk}} - {T_{x0}})} $}}
%        & \multicolumn{1}{|c|}{\multirow{2}{*}{${C_{i0}} + \sum\limits_{x = i}^j {({C_{xk}} - {C_{x0}})} $}} \\
%%        & \multicolumn{1}{|c}{\multirow{2}{*}{$\begin{array}{l}
%%                \sum\limits_{x = i}^j {({T_{xk}} - {T_{x0}})} \\
%%                {\kern 10pt}  + {T_{i0}}
%%                \end{array}$}} 
%%        & \multicolumn{1}{|c}{\multirow{2}{*}{$\begin{array}{l}
%%                \sum\limits_{x = i}^j {({C_{xk}} - {C_{x0}})} \\
%%                {\kern 10pt}  + {C_{i0}}
%%                \end{array}$}}  \\
%
%%Line 16
%        \multicolumn{1}{|c|}{} 
%        &       
%        & \multicolumn{1}{|c}{} 
%        & \multicolumn{1}{|l}{$FAIL(T+\Delta T,C+\Delta C)$} 
%        & \multicolumn{1}{|c}{0} 
%        & \multicolumn{1}{|c}{} 
%        & \multicolumn{1}{|c|}{} \\
%        \cline{2-7}
%
%%Line 17
%        \multicolumn{1}{|c|}{} 
%        & \multirow{3}{*}{$FINISH^U(T,C)$} 
%        & \multicolumn{1}{|c}{不作为} 
%        & \multicolumn{1}{|l}{后续活动$READY^U(T,C)^{[1]}$} 
%        & \multicolumn{1}{|c}{1} 
%        & \multicolumn{1}{|c}{0} 
%        & \multicolumn{1}{|c|}{0} \\
%        \cline{3-7}
%
%%Line 18
%        \multicolumn{1}{|c|}{} 
%        &       
%        & \multicolumn{1}{|c}{终止} 
%        & \multicolumn{1}{|l}{$STOP(T,C+\Delta C)$} 
%        & \multicolumn{1}{|c}{0} 
%        & \multicolumn{1}{|c}{0} 
%        & \multicolumn{1}{|c|}{$fc$} \\
%        \cline{3-7}
%
%%Line 19
%        \multicolumn{1}{|c|}{} 
%        &       
%        & \multicolumn{1}{|c}{重组} 
%        & \multicolumn{1}{|l}{后续活动$READY^{N/U}(T,C)^[1]$} 
%        & \multicolumn{1}{|c}{1} 
%        & \multicolumn{1}{|c}{$\sum\limits_{x = i}^j {({T_{xk}} - {T_{x0}})} $} 
%        & \multicolumn{1}{|c|}{$\sum\limits_{x = i}^j {({C_{xk}} - {C_{x0}})} $}  \\
%        \cline{2-7}
%
%%Line 20
%        \multicolumn{1}{|c|}{} 
%        & $FINISH^N(T,C)$
%        & \multicolumn{1}{|c}{无需决策} 
%        & \multicolumn{1}{|l}{后续活动$READY^N(T,C)^[1]$} 
%        & \multicolumn{1}{|c}{1} 
%        & \multicolumn{1}{|c}{0} 
%        & \multicolumn{1}{|c|}{0} \\
%        \bottomrule
%        
%        \multicolumn{7}{l}{[1] \textit{是否可以过渡到后续活动的READY状态，取决于流程的结构，只有后续活动的所有前序活动均处于}}  \\
%        \multicolumn{7}{l}{\textit{~~~~FINISH且不采用“终止”决策时才能够过渡到READY;}} \\
%        \multicolumn{7}{l}{[2] \textit{$r$为决策后,服务可继续执行的概率; }}  \\
%        \multicolumn{7}{l}{[3] \textit{$S_{ik}$为替换后的服务或者重组后最先执行的服务。 }}  \\
%    \end{tabular}%
%%    \end{tabularx}%
%\end{lrbox}
%\rotatebox[origin=c]{270}{\usebox{\tablebox}}
%\end{table}%




\subsubsection{决策收益} \label{sec:reward_section}
各种动作的目标是“使不确定性造成的损失尽可能小”，但并不保证服务一定能够从异常状态完全回到正常轨道，因此需要分析每种决策对服务执行的影响，计算其损失/受益，以此作为优化决策的依据。

决策动作对原有的服务方案进行了调整，对它的收益度量从以下三个因素入手：

(1)~使服务可以继续向后执行的概率。一般情况下服务失败后需支付给顾客的补偿~$(fc)$~较高，因此决策动作应尽可能保证服务可以继续执行下去。除了补偿上的考虑之外，还考虑到服务执行失败可能造成的客户流失。设决策动作之后，受影响的活动(可能为当前活动，也可能为下一步活动)执行成功的概率为r，那么该部分代价是~$(1-r) \times fc$~。

(2)~若造成时间延迟而需支付的延误成本。设延误时间为~$\Delta T$~，那么该部分的代价是~$\Delta T \times dc$~。

(3)~所引入的新成本~$\Delta C$。~对终止和不作为两种动作来说，新成本为0；对重试动作来说，新成本为重新支付的当前服务使用价格；对替换动作来说，新成本为所选新替代服务的使用价格；对重组动作来说，新成本为所选的多个替代服务的使用价格与原方案中相应服务的使用价格之差。
因此，在当前状态下state采取决策动作action所带来的总收益是：
~$Reward =  - ((1 - r) \times fc + \Delta T \times dc + \Delta C)$~，其中~$r$~、~$\Delta T$~、 ~$\Delta C$~的计算方式如表~\ref{table:state_action}~右侧的三列所示。

\subsubsection{不确定性触发关系图~(UTG)~}
不确定性本身蕴含着服务的一种状态(不正常状态)，它是可以传播的，若不采取任何对策(不作为)，任由某一不确定性蔓延下去，将会造成更严重的后果(成本溢出、时间延误、执行失败)。即使采取了某一种对策，弥补了某些潜在后果，但可能不会完全弥补，因此也会扩散。这里提出不确定性触发关系图~(Uncertainty Triggering Graph, UTG)~表达~UC~之间的触发关系。利用~UTG~来计算不确定性事件及决策动作所引发的直接和间接代价。

UTG可表示为包含两类节点和两类边的有向图~UTG = ~$(rs, SS, AS, TSA, TAS)$，其中：
\begin{itemize}
\item ~$rs=(a_i, state_i)$~表示根状态，代表活动~$a_i$~处于~$state_i$~时所生成的UTG；
\item ~$SS={ss}$~为状态节点集合，其中包含两类节点：第一类为原子状态~$ss=(a_j, state_j)$~，第二类为嵌套的~UTG~根结点，可扩展为一棵完整的~UTG~树；
\item ~$AS={action}$~为决策动作节点的集合；
\item ~$TSA=ss \to action$~表示状态节点到决策动作节点的有向边；
\item ~$TAS=action \to ss$~表示决策动作节点到状态节点的有向边，它具有三个属性：~$tp$~(该状态转移的概率)、~$\Delta T$~(该状态转移所造成的时间延迟)、~$\Delta C$~(该状态转移所造成的成本增加)。
\end{itemize}

如图~\ref{figure:utg_tree}~给出了UTG示意图，其中菱形框表示根状态，圆形节点表示原子状态，矩形框表示决策动作节点，箭头表示~$TSA$~和~$TAS$~。

\begin{figure}[htbp]
    \centering
    \includegraphics[width = 0.3\textwidth]{utg_tree}
    \caption{不确定性事件触发关系图~(UTG)~}\label{figure:utg_tree}
    \vspace{-1em}
\end{figure}

在~UTG~模型中，状态节点可以是一棵~UTG~的根节点，这代表了不同~UTG~之间的连接(不同活动的不确定性状态之间的转换)。若将此类~UTG~节点展开，即可形成如图~\ref{figure:many_utg_tree}~所示的形态。

\begin{figure}[htbp]
    \centering
    \includegraphics[width = 0.5\textwidth]{many_utg_tree}
    \caption{多棵UTG的连接~(UTG)~}\label{figure:many_utg_tree}
    \vspace{-1em}
\end{figure}

如图~\ref{figure:utg_example}~给出一个小例子。假设服务方案是由三个活动~$(a_1, a_2, a_3)$~串行构成的流程，图~(a)~表示活动~$a_1$~在~$READY^U$~状态下的~UTG~，~(b)~表示活动~$a_1$~在~$FINISH^U$~状态下的~UTG~，~(c)~表示~$a_1$~在~$FAIL$~状态下的~UTG~。

\begin{figure}[htbp]
    \centering
    \includegraphics[width = 0.5\textwidth]{utg_example}
    \caption{~UTG~的三个例子}\label{figure:utg_example}
    \vspace{-1em}
\end{figure}

~UTG~的结构与服务方案的流程结构密切相关。当出现不确定性事件之后，更新相关活动、状态和前锋线的信息，进而根据表~\ref{table:state_action}~的相关信息生成~UTG~。

\subsection{业务层面面向不确定性的服务自适应决策模型}

\subsubsection{服务方案}

%此处需要增加业务描述的QoS，需求等等
%
%业务层面的服务不同于如式(~\ref{equation:cs}~)所示的表示方式，其除了软件层面的QoS之外，还具备

业务层面的不确定性采用海运物流业务作为示例，其多方之间的工作流程如图~\ref{figure:bp_example}~所示。它实际上就是一个有向图，将其简化转换之后如图~\ref{figure:bp_ws_process}~所示。

\begin{figure}[htbp]
    \centering
    \includegraphics[width = 0.95\textwidth]{bp_example}
    \caption{海运物流工作流}\label{figure:bp_example}
    \vspace{-1em}
\end{figure}

\begin{figure}[htbp]
    \centering
    \includegraphics[width = 0.7\textwidth]{bp_ws_process}
    \caption{海运物流业务DAG图}\label{figure:bp_ws_process}
    \vspace{-1em}
\end{figure}

\subsubsection{不确定性事件} \label{sec:uc_bp}

业务层面执行比软件层面有更多复杂的不确定性事件，其表示方式如式(\ref{equation:event})所示。其不确定性事件的类型除了~\ref{sec:uc_event}~节所介绍的之外，还增加两类事件：

\begin{itemize}
    
    \item 由用户产生的事件，主要指用户需求发生变化，分为以下几类：
    
    $E_{31}$:~用户所需~QoS~发生变化，包括执行时间，成本(价格)，可靠性等等。
    
    $E_{32}$:~用户所需服务发生变化，主要指某个活动用户需要指定某个服务来执行，或者指定不能由某个服务来执行。

    $E_{33}$:~用户要求终止服务执行。

    \item 由服务执行方产生的事件，主要指服务执行所需的可用资源发生变化，比如海运物流中集装箱的个数由于损坏而变少，则海运无法继续按照原计划执行运输，再如航空领域由于天气原因导致的航班取消，导致于当天能够起飞的飞机数量变少(甚至于减少为0)。这两类统称为服务的可用资源发生变化，分为以下若干小类：
    
    $E_{41}$:~服务所依赖的资源减为0或者完全失效，导致于依赖于此类资源的服务完全不能执行。比如海运物流中，所承载运输的船坏了，所运输的所有物品都不能运输了。
    
    $E_{42}$:~服务所依赖的资源减少一部分，导致于服务依赖的资源不足，服务执行受到影响，但不是完全不能执行。比如海运物流中，舱位个数预留不足，导致于货物不能全部装上，此时只能寻找其他船只的舱位同时运输。
    
    
\end{itemize}

其不确定性事件在不同的活动中是不一样的，因此枚举所有活动中所有可能的不确定性事件如表~\ref{table:ocean_shipping_uc}~所示。

% Table generated by Excel2LaTeX from sheet 'Sheet8'
%\begin{table}[htbp]
%    \caption{海运物流中的不确定性}
%    \vspace{-0.5em}\label{table:ocean_shipping_uc}\centering\zihao{5}
%    \begin{tabular}{cccc}
%         \toprule
%         活动编号  & 活动描述  & 需求的不确定性 & 可用资源的不确定性 \\
%         \midrule
%         ~$a_1$~ & 发布航线信息 & -     & ~$E_{41}$~ ~$E_{42}$~ \\
%         ~$a_2$~ & 询问航线信息 & -     & ~$E_{41}$~ ~$E_{42}$~ \\
%         ~$a_3$~ & 查询、返回航线信息 & ~$E_{31}$~ ~$E_{32}$~ & ~$E_{41}$~ ~$E_{42}$~ \\
%         ~$a_4$~ & 预订舱位  & ~$E_{31}$~ ~$E_{32}$~ & - \\
%         ~$a_5$~ & 接受舱位预订 & -     & ~$E_{41}$~ ~$E_{42}$~ \\
%         ~$a_6$~ & 接受提单  & ~$E_{31}$~ ~$E_{32}$~ & ~$E_{41}$~ ~$E_{42}$~ \\
%         ~$a_7$~ & 预订集装箱 & ~$E_{31}$~ ~$E_{32}$~ & - \\
%         ~$a_8$~ & 预订卡车  & ~$E_{31}$~ ~$E_{32}$~ & - \\
%         ~$a_9$~ & 报关申请  & ~$E_{31}$~   & - \\
%         ~$a_{10}$~ & 确认集装箱预订 & -     & ~$E_{41}$~ ~$E_{42}$~ \\
%         ~$a_{11}$~ & 确认卡车预订 & -     & ~$E_{41}$~ ~$E_{42}$~ \\
%         ~$a_{12}$~ & 报关检查  & -     & ~$E_{41}$~ \\
%         ~$a_{13}$~ & 运输空箱  & ~$E_{31}$~ ~$E_{32}$~ & ~$E_{41}$~ ~$E_{42}$~ \\
%         ~$a_{14}$~ & 装载货物进集装箱 & -     & ~$E_{41}$~ ~$E_{42}$~ \\
%         ~$a_{15}$~ & 铅封集装箱 & ~$E_{32}$~   & ~$E_{41}$~ \\
%         ~$a_{16}$~ & 运输重箱  & -     & ~$E_{41}$~ ~$E_{42}$~ \\
%         ~$a_{17}$~ & 堆存货物  & ~$E_{31}$~ ~$E_{32}$~ & ~$E_{41}$~ ~$E_{42}$~ \\
%         ~$a_{18}$~ & 货物装船  & ~$E_{31}$~ ~$E_{32}$~ & ~$E_{41}$~ ~$E_{42}$~ \\
%         ~$a_{19}$~ & 运输货物至目的地 & -     & ~$E_{41}$~ \\
%         \bottomrule
%    \end{tabular}%
%\end{table}%

\begin{table}[htbp]
    \caption{海运物流中的不确定性}
    \vspace{-0.5em}\label{table:ocean_shipping_uc}\centering\zihao{5}
    \begin{tabularx}{\textwidth}{cX}
    \toprule
        活动编号  & \multicolumn{1}{c}{可能的不确定性} \\
    \midrule
    ~$a_1$~ & ~$E_{41}$:(天气原因)轮船不能航行;~$E_{42}$:(轮船损坏)轮船数量减少; \\
    ~$a_2$~ & ~$E_{41}$:(天气原因)轮船不能航行;~$E_{42}$:(轮船损坏)轮船数量减少; \\
    ~$a_3$~ & ~$E_{31}$:需求的价格/运输时间/可靠性发生变化;~$E_{32}$:用户指定需要某(种)条船;~$E_{41}$:轮船不能航行;~$E_{42}$:轮船数量减少; \\
    ~$a_4$~ & ~$E_{31}$:需求的价格发生变化;~$E_{32}$:用户指定需要某个(种)舱位; \\
    ~$a_5$~ & ~$E_{41}$:(海关原因)舱位完全不能满足;~$E_{42}$:(轮船损坏)能提供的舱位数量不足; \\
    ~$a_6$~ & ~$E_{31}$:需求的价格发生变化;~$E_{32}$:用户指定需要某个/种舱位;~$E_{41}$:舱位完全不能满足;~$E_{42}$:能提供的舱位数量不足; \\
    ~$a_7$~ & ~$E_{31}$:需求的集装箱成本变化;~$E_{32}$:用户指定更换为某批/种集装箱; \\
    ~$a_8$~ & ~$E_{31}$:需求的卡车运输成本/运输时间发生变化;~$E_{32}$:用户指定要求另一批/类型卡车运输; \\
    ~$a_9$~ & ~$E_{31}$:需求报关时间变化; \\
    ~$a_{10}$~ & ~$E_{41}$:集装箱完全不能满足;~$E_{42}$:集装箱只能满足部分需求; \\
    ~$a_{11}$~ & ~$E_{41}$:卡车完全不能满足;~$E_{42}$:卡车只能满足部分需求; \\
    ~$a_{12}$~ & ~$E_{41}$:报关被拒,完全失败; \\
    ~$a_{13}$~ & ~$E_{31}$:需求的集装箱成本变化;~$E_{32}$:用户指定更换为某批/种集装箱;~$E_{41}$:运输过程中车祸集装箱全部损坏;~$E_{42}$:运输过程中集装箱部分损坏; \\
    ~$a_{14}$~ & ~$E_{41}$:货物不能装在此类集装箱;~$E_{42}$:货物只能装部分集装箱; \\
    ~$a_{15}$~ & ~$E_{32}$:需求更换为某批/种集装箱;~$E_{41}$:车队技术工人无法上班,不能铅封; \\
    ~$a_{16}$~ & ~$E_{41}$:车队无法运输所有集装箱;~$E_{42}$:车祸损坏了部分集装箱; \\
    ~$a_{17}$~ & ~$E_{31}$:需求成本/可靠性变化;~$E_{32}$:需求更换场站;~$E_{41}$:场站不能堆存货物;~$E_{42}$:场站只能堆存部分货物; \\
    ~$a_{18}$~ & ~$E_{31}$:需求成本变化;~$E_{32}$:需求更换船只;~$E_{41}$:货物不能装船;~$E_{42}$:货物只能部分装船; \\
    ~$a_{19}$~ & ~$E_{41}$:货物中途出现问题,被退回来或不能到达; \\
    \bottomrule
    \end{tabularx}%
\end{table}%

\subsubsection{服务执行的状态}

(1)~单个活动的状态
服务执行的状态仍然如~\ref{sec:service_state}~节介绍，单个活动之间的状态转换关系如图~\ref{figure:state_trans_pb}~所示。

\begin{figure}[htbp]
    \centering
    \includegraphics[width = 0.6\textwidth]{state_trans_bp}
    \caption{业务层面服务活动的状态转换关系}\label{figure:state_trans_pb}
    \vspace{-1em}
\end{figure}

业务层面服务活动之间的状态转换不同于如图~\ref{figure:state_trans}~所示的~Web Service~服务活动之间的状态转换，其不同点主要有：

1)~业务层面的不确定性事件包含了~Web Service~层面的所有不确定性事件，并具备~\ref{sec:uc_bp}~节所介绍的业务层面不确定性；

2)~业务层面在$READY$状态时会有用户的需求或者外部环境的变化，使得服务执行到另外的状态；而在纯的~Web Service~层面无需对$READY$状态的不确定性进行考虑；

3)~业务层面在$EXEC$状态也会有用户的需求或者外部环境的变化而导致于服务执行状态发生变化，甚至于引起服务执行失败；而在~Web Service~层面仅仅需要等到服务执行完的事件触发~$E_{21}/E_{22}$~。

(2)~服务执行的整体状态

在业务层面，由于不同的事件会使得流程执行到不同的状态，并且业务层面的需求和外部环境是可观察的，这与~Web Service~层面不同。因此，处理服务不确定性时需要确定是由用户需求导致的还是由外部环境变化导致的，从而整体服务流程的状态可由前锋线上的状态和不确定性事件源组合而成，如式(\ref{equation:state_total_bp})所示。

\begin{equation}\label{equation:state_total_bp}
state = < state(a_i),state(a_{i+1}),..., state(a_j), event >
\end{equation}
\begin{tabularx}{\textwidth}{@{}l@{\quad}l@{\pozhehao }X@{}}
    式中
    & $state(a_i)$ & 活动~$a_i$~的状态；\\
    & $event$ & 使得服务处于当前状态的不确定性事件，如式(\ref{equation:event})所示。
\end{tabularx}\vspace{\wordsep}

业务层面的不确定性事件也包含软件层面的不确定性事件，而软件层面的不确定性事件是不可观测的，因此若服务状态是由软件层面的不确定性事件触发，则式(\ref{equation:state_total_bp})中的~$event$~取值为~$NULL$~。

\subsubsection{决策动作}

业务层面的决策动作如同软件层面的决策动作，只是决策时刻不只是在服务执行结束时，而且在服务未执行时若有不确定性事件发生也会进行决策，换句话说，决策不仅包括对当前所执行服务的决策，并对预测的非正常服务也执行决策。

同时，业务层面的不确定性一旦发生，就必须做出决策，这是因为无论用户需求发生变化还是外部环境发生变化，若不进行动作（不作为）则会导致业务执行下来不满足用户需求或者彻底失败，而这两种结果不是想要的结果。

\subsubsection{事件、决策和状态之间的关系}

%\begin{threeparttable}
%\zihao{5}\begin{longtable}{clclccc}
%    \caption{服务状态与决策动作之间的关系(业务层面)\label{table:state_action_bp}}\vspace{-0.5em}\\
%    \toprule 事件源 & 状态类型$^{[1]}$ & 决策动作 & 决策后可能的状态$^{[1]}$ & $r^{[2]}$ & {$\Delta T$} & {$\Delta C$}  \\ \midrule
%    \endfirsthead
%    \multicolumn{3}{c}{表~\thetable（续表）}\vspace{0.5em}\\
%    \toprule 事件源\tnote{1} & 状态类型$^{[1]}$ & 决策动作 & 决策后可能的状态$^{[1]}$ & $r^{[2]}$ & {$\Delta T$} & {$\Delta C$}  \\ \midrule
%    \endhead
%    \bottomrule
%%      \multicolumn{7}{l}{[1]~\textit{决策前的状态所带参数为$(T,C)$,决策后状态参数变为$(T+\Delta T, C+\Delta C)$,}} \\
%%      \multicolumn{7}{l}{~~~~~\textit{其中$\Delta T \ge 0$和$\Delta C \ge 0$;}} \\
%%      \multicolumn{7}{l}{[2]~\textit{$r$为决策后,服务可继续执行的概率; }}\\
%%      \multicolumn{7}{l}{[3]~\textit{$S_{ik}$为替换后的服务或者重组后最先执行的服务。 }}
%
%    \endfoot

%\end{longtable}\zihao{-4}
%
%\end{threeparttable}


% Table generated by Excel2LaTeX from sheet 'Sheet11'

\begin{table}[htbp]
    \caption{服务状态与决策动作之间的关系(业务层面)}
    \vspace{-0.5em}\label{table:state_action_bp}\centering\zihao{5}
    \begin{threeparttable}
    \begin{tabular}{clclccc}
        \toprule
        事件源 & 状态类型\tnote{1} & 决策动作 & 决策后可能状态\tnote{1} & $r$~\tnote{2} & {$\Delta T$} & {$\Delta C$} \\
        \midrule

        %------------------------------------------------------
        {$E_{31}$} 
        & {${READY^U}$}
        & {终止}
        & {$STOP$} 
        & {0} 
        & {0} 
        & {$fc$} \\
        
        {}
        & {}
        & {替换} 
        & {$FINISH$} 
        & $R_{ik}\tnote{3}$ 
        & {\multirow{2}{*}{$T_{ik}-T_{i0}$}} 
        & {\multirow{2}{*}{$C_{ik}-C_{i0}$}} \\
        
        {}
        & {}
        & {} 
        & {$FAIL$} 
        & {0}
        & {} 
        & {} \\
        
        {}
        & {}
        & {重组} 
        & {$FINISH^{N/U}$} 
        & $R_{ik}\tnote{3}$ 
        & {\multirow{2}{*}{$\sum\limits_{x = i}^j {({T_{xk}} - {T_{x0}})} $}}
        & {\multirow{2}{*}{$\sum\limits_{x = i}^j {({C_{xk}} - {C_{x0}})} $}} \\
        
        
        {}
        & {}
        & {} 
        & {$FAIL$} 
        & {0}
        & {} 
        & {} \\
        
        %------------------------------------------------------
        {} 
        & {${FAIL}$}
        & {终止}
        & {$STOP$} 
        & {0} 
        & {0} 
        & {$fc$} \\
        
        {}
        & \multicolumn{1}{r}{$/EXEC^U$}
        & {替换} 
        & {${FINISH}^{N/U}$} 
        & $R_{ik}\tnote{3}$ 
        & {\multirow{2}{*}{$T_{ik}$}} 
        & {\multirow{2}{*}{$C_{ik}$}} \\
        
        {}
        & {}
        & {} 
        & {$FAIL$} 
        & {0}
        & {} 
        & {} \\
        
        {}
        & {}
        & {重组} 
        & {$FINISH^{N/U}$} 
        & $R_{ik}\tnote{3}$ 
        & {\multirow{2}{*}{$T_{i0}+\sum\limits_{x = i}^j {({T_{xk}} - {T_{x0}})} $}}
        & {\multirow{2}{*}{$C_{i0}+\sum\limits_{x = i}^j {({C_{xk}} - {C_{x0}})} $}} \\
        
        
        {}
        & {}
        & {} 
        & {$FAIL$} 
        & {0}
        & {} 
        & {} \\
        
        %------------------------------------------------------
        {} 
        & {${FINISH^U}$}
        & {终止}
        & {$STOP$} 
        & {0} 
        & {0} 
        & {$fc$} \\
        
        {}
        & {}
        & {重组} 
        & {$FINISH^{N/U}$} 
        & $R_{ik}\tnote{3}$ 
        & {\multirow{2}{*}{$\sum\limits_{x = i}^j {({T_{xk}} - {T_{x0}})} $}}
        & {\multirow{2}{*}{$\sum\limits_{x = i}^j {({C_{xk}} - {C_{x0}})} $}} \\
        
        
        {}
        & {}
        & {} 
        & {$FAIL$} 
        & {0}
        & {} 
        & {} \\
        %------------------------------------------------------
        {$E_{32}$} 
        & {$READY^U$}
        & {替换} 
        & {$FINISH$} 
        & $R_{ik}\tnote{3}$ 
        & {\multirow{2}{*}{$T_{ik}-T_{i0}$}} 
        & {\multirow{2}{*}{$C_{ik}-C_{i0}$}} \\
        
        {}
        & {}
        & {} 
        & {$FAIL$} 
        & {0}
        & {} 
        & {} \\
        
        {}
        & {}
        & {重组} 
        & {$FINISH^{N/U}$} 
        & $R_{ik}\tnote{3}$ 
        & {\multirow{2}{*}{$\sum\limits_{x = i}^j {({T_{xk}} - {T_{x0}})} $}}
        & {\multirow{2}{*}{$\sum\limits_{x = i}^j {({C_{xk}} - {C_{x0}})} $}} \\
        
        
        {}
        & {}
        & {} 
        & {$FAIL$} 
        & {0}
        & {} 
        & {} \\
        
        %------------------------------------------------------
        {$E_{33}$} 
        & {${READY^U}$}
        & {终止}
        & {$STOP$} 
        & {0} 
        & {0} 
        & {$fc$} \\
        %------------------------------------------------------
        {$E_{41}$} 
        & {${FAIL^U}$}
        & {终止}
        & {$STOP$} 
        & {0} 
        & {0} 
        & {$fc$} \\
        
        {}
        & {}
        & {替换} 
        & {$FINISH$} 
        & $R_{ik}\tnote{3}$ 
        & {\multirow{2}{*}{$T_{ik}$}} 
        & {\multirow{2}{*}{$C_{ik}$}} \\
        
        {}
        & {}
        & {} 
        & {$FAIL$} 
        & {0}
        & {} 
        & {} \\
        
        {}
        & {}
        & {重组} 
        & {$FINISH^{N/U}$} 
        & $R_{ik}\tnote{3}$ 
        & {\multirow{2}{*}{$T_{i0}+\sum\limits_{x = i}^j {({T_{xk}} - {T_{x0}})} $}}
        & {\multirow{2}{*}{$C_{i0}+\sum\limits_{x = i}^j {({C_{xk}} - {C_{x0}})} $}} \\
        
        
        {}
        & {}
        & {} 
        & {$FAIL$} 
        & {0}
        & {} 
        & {} \\
        %------------------------------------------------------
        {$E_{42}$} 
        & {${READY^U}$}
        & {终止}
        & {$STOP$} 
        & {0} 
        & {0} 
        & {$fc$} \\
        
        {}
        & {}
        & {替换} 
        & {$FINISH$} 
        & $R_{ik}\tnote{3}$ 
        & {\multirow{2}{*}{$T_{ik}-T_{i0}$}} 
        & {\multirow{2}{*}{$C_{ik}-C_{i0}$}} \\
        
        {}
        & {}
        & {} 
        & {$FAIL$} 
        & {0}
        & {} 
        & {} \\
        
        {}
        & {}
        & {重组} 
        & {$FINISH^{N/U}$} 
        & $R_{ik}\tnote{3}$ 
        & {\multirow{2}{*}{$\sum\limits_{x = i}^j {({T_{xk}} - {T_{x0}})} $}}
        & {\multirow{2}{*}{$\sum\limits_{x = i}^j {({C_{xk}} - {C_{x0}})} $}} \\
        
        
        {}
        & {}
        & {} 
        & {$FAIL$} 
        & {0}
        & {} 
        & {} \\
        %------------------------------------------------------
        {} 
        & {${EXEC^U}$}
        & {终止}
        & {$STOP$} 
        & {0} 
        & {0} 
        & {$fc$} \\
        
        {}
        & \multicolumn{1}{r}{$/FINISH^U$}
        & {替换} 
        & {$FINISH$} 
        & $R_{ik}\tnote{3}$ 
        & {\multirow{2}{*}{$T_{ik}$}} 
        & {\multirow{2}{*}{$C_{ik}$}} \\
        
        {}
        & {}
        & {} 
        & {$FAIL$} 
        & {0}
        & {} 
        & {} \\
        
        {}
        & {}
        & {重组} 
        & {$FINISH^{N/U}$} 
        & $R_{ik}\tnote{3}$ 
        & {\multirow{2}{*}{$T_{i0}+\sum\limits_{x = i}^j {({T_{xk}} - {T_{x0}})} $}}
        & {\multirow{2}{*}{$C_{i0}+\sum\limits_{x = i}^j {({C_{xk}} - {C_{x0}})} $}} \\
        
        
        {}
        & {}
        & {} 
        & {$FAIL$} 
        & {0}
        & {} 
        & {} \\

        \bottomrule
    \end{tabular}%
    
    \begin{tablenotes}
        \item[1] 决策动作前状态所带参数为$(T,C)$, 决策后状态参数变为~$(T+\Delta T, C+\Delta C)$,~ 其中~$\Delta T \ge 0$, ~$\Delta C \ge 0$~; 
        \item[2] $r$~为决策后,服务可继续执行的概率;
        \item[3] $S_{ik}$~为替换后的服务或者重组后最先执行的服务，~$R_{ik}$~为此服务的可靠性。
%        是否可以过渡到后续活动的~$READY$~状态，取决于流程的结构，只有后续活动的所有前序活动均处于~$FINISH$~且不采用“终止”决策时才能够过渡到READY;
    \end{tablenotes}
\end{threeparttable}
\end{table}%


\subsubsection{决策收益}

\subsubsection{不确定性触发关系图}


\subsection{基于~MDP~的不确定性决策方法}
马尔科夫决策过程~(MDP)\citeup{liuke2004}~将马尔可夫过程与确定性的动态规划相结合，决策者周期或连续观察随机动态系统，序贯的做出决策，系统下一步的状态是随机的，并且其状态转移概率具有马尔可夫性。决策者根据新观察到的状态，再作新的决策，依此反复地进行。通过此种决策，使系统运行的全过程达到某种最优运行效果，选取控制系统发展的最优策略。

\subsubsection{模型}

服务执行过程中面临的各种不确定性以及对其所做出的决策，符合~Markov~决策过程的定义。因此，采用基于~MDP~的方法进行服务自适应演化过程中的决策，根据当前服务执行状态、发生的不确定性事件、不确定性事件之间的触发关系~(UTG)~，考虑未来的收益和代价，做出当前不确定状态下的最优决策。

按照~MDP~的数学模型，需要首先建立决策时刻~$T$~、服务状态~$S$~、决策动作~$A$~、转移概率~$P$~、代价~$Reward$~的数学表达。

(1)~时刻~$T$~: 前服务环节执行中/执行后发生不确定事件、或者预知到尚未执行的环节将会发生不确定事件时开始决策，此时为时刻0。如图~\ref{figure:many_utg_tree}~所示的多棵~UTG~连接形成完全触发关系图，叶子结点的状态处于最终时刻~$V$~，“完全触发关系图”的层数是周期个数。这是一个不定周期的时刻序列。

(2)~状态~$S$~: 服务前锋线上的所有活动的状态即可表示为服务流程的状态，原因是前锋线上的活动状态已知，则可知所有活动的状态。将服务流程的所有活动的六种状态组成一个状态集合，形成~MDP~状态~$state$~, 即~$state =  < state({a_1}),state({a_2}), \ldots ,state({a_n}) >$~，每个状态附着两个参数(~$T$~和~$C$~)；

(3)~动作~$A$~：共有终止、不作为、重试、替换、重组五个动作，不同状态下可执行的动作集合有所不同(见表~\ref{table:state_action}~)。

(4)~转移概率~$P$~：转移概率由当前的决策动作和服务活动的状态联合决定，即~$p(state_j|state_i,action)$~的值有以下几类情况：
\begin{itemize}
\item ~$1;~if~action = continue/terminate$~
\item ~$reliability;~if~action = retry/substitute/re-compose~ \& ~ state_j = FINIS{H^{N/U}}$~
\item ~$1 - reliability;~if~action = retry/substitute/re-compose ~\& ~ state_j = FAIL$~
\end{itemize}
其中~$reliability$~指的是将要执行的服务端可靠性，若有多个服务，则是多个服务可靠性之积。

(5)~报酬函数~$Reward$~：在~\ref{sec:reward_section}~节中给出。

\subsubsection{算法}

基于上述五个方面的基本定义，采用有限阶段向后递归迭代~MDP~算法进行最优决策序列的求解，得到对当前服务的决策动作。

算法：基于~MDP~的服务不确定性优化决策

输入：服务方案~$SPlan$~、与当前发生的不确定性事件相关的活动~$activity$~、
~$SPlan$~中各个活动的当前状态；

输出：最优马氏策略及其成本

步骤1~根据出现故障的活动~$a$~，按照表~\ref{table:state_action}~构造~UTG~，并将多棵~UTG~连接形成“完全触发关系图”，从而形成状态转移表；

步骤2~定义当前的不确定状态为时刻0，以此生成向后衍生的UTG，直至服务方案最后一个结点，此时为最终时刻V。从而生成0到~$V$~的~$V+1$~个时刻的若干个状态、若干个动作、相应的转移概率报酬；

步骤3~令~$t=V$~，且对所有~$V$~时刻的状态~$state_V \in S$~，令~${u_V}( {state_V} ) = Reward_V( {state_V} )$;

步骤4~如果~$t=0$~，则~$\pi  = (f_0,f_1,\ldots ,f_{V-1})$~为最优的马氏策略，而~${u_0}( state_0)$~为最优的值函数，算法停止。否则，令~$t=t–1$~，进入步骤5；

步骤5~对所有~$state_t \in S$~，计算

\begin{equation}\label{equation:backward_mdp}
\begin{array}{l}
{u_t}(stat{e_t}) = \mathop {\max }\limits_{action \in Action(stat{e_t})} \{ Rewar{d_t}(stat{e_t},action)\\
{\rm{                        }} + \sum\limits_{stat{e_{t + 1}} \in S} {{p_t}(stat{e_{t + 1}}|stat{e_t},action){u_{t + 1}}(stat{e_{t + 1}})} \} 
\end{array}
\end{equation}

并记集合

\begin{equation}\label{equation:backward_mdp_arg}
\begin{array}{l}
Actio{n_t}(stat{e_t}) = \mathop {\arg \max }\limits_{action \in Action(stat{e_t})} \{ Rewar{d_t}(stat{e_t},action)\\
{\rm{                       }} + \sum\limits_{stat{e_{t + 1}} \in S} {{p_t}(stat{e_{t + 1}}|stat{e_t},action){u_{t + 1}}(stat{e_{t + 1}})} \} 
\end{array}
\end{equation}

任意取~$f_t(state_t) \in Action_t(state_t)$~，于是定义了~$t$~时刻的决策规则~$f_t$~。而0时刻的决策~$f_0$~则是对当前故障时刻的故障状态采取最优的直接动作。

步骤6~返回步骤3。


\subsection{原型系统}
文本

\subsection{海运物流业务的不确定性决策系统}
文本


\subsection{预期达到的目标和取得的研究成果}
文本

\subsection{进度安排}
文本
